############################################################
# 1. FORCE HTTPS + CANONICAL NON-WWW DOMAIN
############################################################

RewriteEngine On
RewriteCond %{HTTPS} off [OR]
RewriteCond %{HTTP_HOST} ^www\.sandokan\.cat$ [NC]
RewriteRule ^(.*)$ https://sandokan.cat/$1 [R=301,L]

############################################################
# 2. SECURITY: 
############################################################

# 2.1 DISABLE DIRECTORY LISTING
Options -Indexes

# 2.2 BLOCK HIDDEN OR PRIVATE DIRECTORIES
RewriteRule (^|/)[._] - [F,L]

# 2.3 BLOCK SENSITIVE FILES
<FilesMatch "(^\_|\.|\.env|\.env\..*|\.secret|~$|\.bak$|\.swp$|\.dist$|\.example$|\.conf$|\.ini$|\.log$|\.sql$|\.jsonl$|composer\.(json|lock)|package\.json|yarn\.lock|webpack\.config|gulpfile\.js)">
    Require all denied
</FilesMatch>

# 2.4 BLOCK VCS FOLDERS
RedirectMatch 404 ^/(?:\.git|\.svn|\.hg|\.bzr)(?:/|$)

# 2.4 ALLOW ACCESS TO STATIC FILES
<FilesMatch "\.(html?|xhtml|php|cgi|pl|py|asp|aspx|jsp|xml|json|txt|md|csv|yml|yaml|ini|conf|css|js|mjs|jsx|ts|tsx|map|java|class|jar|wasm|otf|ttf|tiff|eot|woff2?|svg|ico|jpg|jpeg|png|gif|webp|avif|bmp|heic|heif|mp3|ogg|wav|flac|aac|mp4|webm|ogv|mov|avi|mkv|m4v|3gp|pdf|odt|ods|odp|doc|docx|xls|xlsx|ppt|pptx|rtf|epub|zip|7z|rar|tar|gz|gzip|bz2|xz|zst|dmg|iso|apk|exe|msi)$">
    Require all granted
</FilesMatch>

############################################################
# 3. ENCODING
############################################################

AddDefaultCharset UTF-8

############################################################
# 4. COMPRESSION: BROTLI + GZIP
############################################################

<IfModule mod_brotli.c>
    AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml image/svg+xml application/font-woff application/font-woff2 application/wasm
</IfModule>

<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml image/svg+xml application/font-woff application/font-woff2 application/wasm 
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
</IfModule>

############################################################
# 5 CACHE AND HEADERS
############################################################

# 5.1 CACHING
<IfModule mod_headers.c>
    # DINAMIC FILES
    <FilesMatch "\.(html?|xhtml|php|cgi|pl|py|asp|aspx|jsp)$">
        Header set Cache-Control "public, max-age=86400, must-revalidate"
    </FilesMatch>

    # STATIC FILES
    <FilesMatch "\.(xml|json|txt|md|csv|yml|yaml|ini|conf|css|js|mjs|jsx|ts|tsx|map|java|class|jar|wasm|otf|ttf|tiff|eot|woff2?|svg|ico|jpg|jpeg|png|gif|webp|avif|bmp|heic|heif|mp3|ogg|wav|flac|aac|mp4|webm|ogv|mov|avi|mkv|m4v|3gp|pdf|odt|ods|odp|doc|docx|xls|xlsx|ppt|pptx|rtf|epub|zip|7z|rar|tar|gz|gzip|bz2|xz|zst|dmg|iso|apk|exe|msi)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
</IfModule>

<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 1 year"

    # DYNAMIC
    ExpiresByType text/html "access plus 1 day"
    ExpiresByType application/xhtml+xml "access plus 1 day"

    # DATA / CONFIG
    ExpiresByType text/xml "access plus 1 year"
    ExpiresByType application/xml "access plus 1 year"
    ExpiresByType application/json "access plus 1 year"
    ExpiresByType application/ld+json "access plus 1 year"
    ExpiresByType text/plain "access plus 1 year"
    ExpiresByType text/csv "access plus 1 year"
    ExpiresByType application/yaml "access plus 1 year"
    ExpiresByType application/wasm "access plus 1 year"

    # TEXT-BASED
    ExpiresByType text/markdown "access plus 1 year"
    ExpiresByType text/yml "access plus 1 year"
    ExpiresByType text/x-component "access plus 1 year"

    # CODE / STYLES
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType text/javascript "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"

    # SCRIPTS & MAPS
    ExpiresByType application/x-javascript "access plus 1 year"

    # IMAGES
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/avif "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType image/bmp "access plus 1 year"
    ExpiresByType image/tiff "access plus 1 year"
    ExpiresByType image/heif "access plus 1 year"

    # FONTS
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
    ExpiresByType application/font-sfnt "access plus 1 year"

    # AUDIO / VIDEO
    ExpiresByType audio/mpeg "access plus 1 year"
    ExpiresByType audio/ogg "access plus 1 year"
    ExpiresByType audio/wav "access plus 1 year"
    ExpiresByType audio/x-wav "access plus 1 year"
    ExpiresByType video/mp4 "access plus 1 year"
    ExpiresByType video/webm "access plus 1 year"
    ExpiresByType video/ogg "access plus 1 year"
    ExpiresByType video/x-msvideo "access plus 1 year"
    ExpiresByType video/quicktime "access plus 1 year"
    ExpiresByType video/x-matroska "access plus 1 year"

    # DOCUMENTS / ARCHIVES
    ExpiresByType application/pdf "access plus 1 year"
    ExpiresByType application/msword "access plus 1 year"
    ExpiresByType application/vnd.openxmlformats-officedocument.wordprocessingml.document "access plus 1 year"
    ExpiresByType application/vnd.ms-excel "access plus 1 year"
    ExpiresByType application/vnd.openxmlformats-officedocument.spreadsheetml.sheet "access plus 1 year"
    ExpiresByType application/vnd.ms-powerpoint "access plus 1 year"
    ExpiresByType application/vnd.openxmlformats-officedocument.presentationml.presentation "access plus 1 year"
    ExpiresByType application/zip "access plus 1 year"
    ExpiresByType application/x-7z-compressed "access plus 1 year"
    ExpiresByType application/x-rar-compressed "access plus 1 year"
    ExpiresByType application/x-tar "access plus 1 year"
    ExpiresByType application/gzip "access plus 1 year"
    ExpiresByType application/x-bzip2 "access plus 1 year"
    ExpiresByType application/x-xz "access plus 1 year"
    ExpiresByType application/x-zstd "access plus 1 year"
</IfModule>

# 5.2 DISABLE ETAGS
FileETag None
<IfModule mod_headers.c>
    Header unset ETag
</IfModule>

############################################################
# 6. SECURITY HEADERS (HTTPS ONLY)
############################################################

<IfModule mod_headers.c>
    # HSTS
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # SECURITY HEADERS
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "fullscreen=(self), clipboard-write=(self)"
    Header always set X-Permitted-Cross-Domain-Policies "none"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Cross-Origin-Resource-Policy "same-origin"
    Header always set Cross-Origin-Embedder-Policy "require-corp"
    Header always set Cross-Origin-Opener-Policy "same-origin"

    # CSP REPORTING
    Header always set Report-To '{"group":"csp-endpoint","max_age":10886400,"endpoints":[{"url":"https://sandokan.cat/_secure/CSPreport"}],"include_subdomains":true}'
</IfModule>

############################################################
# 7. ERROR PAGES (FULL LIST)
############################################################

# 7.0 Defaults
DirectoryIndex index.php
FallbackResource /index.php

# 7.1 Client errors (4xx)
ErrorDocument 400 /partials/error.php?code=400
ErrorDocument 401 /partials/error.php?code=401
ErrorDocument 402 /partials/error.php?code=402
ErrorDocument 403 /partials/error.php?code=403
ErrorDocument 404 /partials/error.php?code=404
ErrorDocument 405 /partials/error.php?code=405
ErrorDocument 406 /partials/error.php?code=406
ErrorDocument 407 /partials/error.php?code=407
ErrorDocument 408 /partials/error.php?code=408
ErrorDocument 409 /partials/error.php?code=409
ErrorDocument 410 /partials/error.php?code=410
ErrorDocument 411 /partials/error.php?code=411
ErrorDocument 412 /partials/error.php?code=412
ErrorDocument 413 /partials/error.php?code=413
ErrorDocument 414 /partials/error.php?code=414
ErrorDocument 415 /partials/error.php?code=415
ErrorDocument 416 /partials/error.php?code=416
ErrorDocument 417 /partials/error.php?code=417
ErrorDocument 421 /partials/error.php?code=421
ErrorDocument 422 /partials/error.php?code=422
ErrorDocument 423 /partials/error.php?code=423
ErrorDocument 424 /partials/error.php?code=424
ErrorDocument 426 /partials/error.php?code=426
ErrorDocument 428 /partials/error.php?code=428
ErrorDocument 429 /partials/error.php?code=429
ErrorDocument 431 /partials/error.php?code=431
ErrorDocument 451 /partials/error.php?code=451

# 7.2 Server errors (5xx)
ErrorDocument 500 /partials/error.php?code=500
ErrorDocument 501 /partials/error.php?code=501
ErrorDocument 502 /partials/error.php?code=502
ErrorDocument 503 /partials/error.php?code=503
ErrorDocument 504 /partials/error.php?code=504
ErrorDocument 505 /partials/error.php?code=505
ErrorDocument 506 /partials/error.php?code=506
ErrorDocument 507 /partials/error.php?code=507
ErrorDocument 508 /partials/error.php?code=508
ErrorDocument 511 /partials/error.php?code=511
